#!/usr/bin/env node

/**
 * Extract Documentation Screenshots
 *
 * This script copies screenshots generated by Playwright E2E tests
 * to a documentation directory for easy inclusion in docs.
 *
 * Usage:
 *   node scripts/extract-docs-screenshots.js
 *
 * Output:
 *   docs/screenshots/ - Organized screenshots for documentation
 */

const fs = require('fs');
const path = require('path');

const SOURCE_DIR = path.join(__dirname, '../test/e2e/dashboard-docs.e2e.spec.js-snapshots');
const TARGET_DIR = path.join(__dirname, '../docs/screenshots');

// Screenshot mapping: source filename -> target category and filename
const SCREENSHOT_MAPPING = {
    // Main Views
    'docs-01-overview': { category: '', target: 'overview' },
    'docs-02-routing': { category: '', target: 'routing' },
    'docs-03-requests': { category: '', target: 'requests' },
    'docs-04-system': { category: '', target: 'system' },

    // Themes
    'docs-themes-01-dark-theme': { category: 'themes', target: 'dark-theme' },
    'docs-themes-02-light-theme': { category: 'themes', target: 'light-theme' },

    // Density
    'docs-density-01-compact': { category: 'density', target: 'compact' },
    'docs-density-02-comfortable': { category: 'density', target: 'comfortable' },

    // Sections
    'docs-sections-01-health-ribbon': { category: 'sections', target: 'health-ribbon' },
    'docs-sections-02-keys-heatmap': { category: 'sections', target: 'keys-heatmap' },
    'docs-sections-03-cost-panel': { category: 'sections', target: 'cost-panel' },
    'docs-sections-04-charts': { category: 'sections', target: 'charts' },

    // Panels
    'docs-panels-live-collapsed': { category: 'panels', target: 'live-collapsed' },
    'docs-panels-live-expanded': { category: 'panels', target: 'live-expanded' },
    'docs-panels-live-content': { category: 'panels', target: 'live-content' },

    // Dock Tabs
    'docs-dock-tabs-01-traces': { category: 'dock-tabs', target: 'traces' },
    'docs-dock-tabs-02-logs': { category: 'dock-tabs', target: 'logs' },
    'docs-dock-tabs-03-queue': { category: 'dock-tabs', target: 'queue' },
    'docs-dock-tabs-04-circuit': { category: 'dock-tabs', target: 'circuit' },

    // Routing
    'docs-routing-01-tier-builder': { category: 'routing', target: 'tier-builder' },

    // Modals
    'docs-modals-keyboard-shortcuts': { category: 'modals', target: 'keyboard-shortcuts' },

    // System
    'docs-system-01-error-breakdown': { category: 'system', target: 'error-breakdown' },
    'docs-system-02-retry-analytics': { category: 'system', target: 'retry-analytics' },
    'docs-system-03-health-score': { category: 'system', target: 'health-score' },

    // Progressive Disclosure
    'docs-progressive-advanced-stats-collapsed': { category: 'progressive', target: 'advanced-stats-collapsed' },
    'docs-progressive-advanced-stats-expanded': { category: 'progressive', target: 'advanced-stats-expanded' },
    'docs-progressive-process-health-collapsed': { category: 'progressive', target: 'process-health-collapsed' },
    'docs-progressive-process-health-expanded': { category: 'progressive', target: 'process-health-expanded' },

    // Responsive
    'docs-responsive-mobile-375px': { category: 'responsive', target: 'mobile-375px' },
    'docs-responsive-tablet-768px': { category: 'responsive', target: 'tablet-768px' },
    'docs-responsive-desktop-1920px': { category: 'responsive', target: 'desktop-1920px' },

    // Components (Focused Element Screenshots)
    // Header Components
    'docs-components-page-nav-tabs': { category: 'components', target: 'page-nav-tabs' },
    'docs-components-theme-toggle': { category: 'components', target: 'theme-toggle' },
    'docs-components-density-selector': { category: 'components', target: 'density-selector' },
    'docs-components-time-range-selector': { category: 'components', target: 'time-range-selector' },
    'docs-components-connection-status': { category: 'components', target: 'connection-status' },
    'docs-components-pause-button': { category: 'components', target: 'pause-button' },

    // Key Management Components
    'docs-components-key-card': { category: 'components', target: 'key-card' },
    'docs-components-key-card-closed': { category: 'components', target: 'key-card-closed' },
    'docs-components-key-card-half-open': { category: 'components', target: 'key-card-half-open' },

    // Model Routing Components
    'docs-components-tier-card-heavy': { category: 'components', target: 'tier-card-heavy' },
    'docs-components-tier-card-medium': { category: 'components', target: 'tier-card-medium' },
    'docs-components-tier-card-light': { category: 'components', target: 'tier-card-light' },
    'docs-components-model-list-item': { category: 'components', target: 'model-list-item' },

    // Request List Components
    'docs-components-trace-row': { category: 'components', target: 'trace-row' },
    'docs-components-log-entry': { category: 'components', target: 'log-entry' },

    // System Components
    'docs-components-circuit-status-indicator': { category: 'components', target: 'circuit-status-indicator' },

    // Chart Components
    'docs-components-request-rate-chart': { category: 'components', target: 'request-rate-chart' },
    'docs-components-latency-chart': { category: 'components', target: 'latency-chart' },
};

function ensureDir(dir) {
    if (!fs.existsSync(dir)) {
        fs.mkdirSync(dir, { recursive: true });
    }
}

function generateMarkdownIndex() {
    const categories = {
        '': { title: 'Main Views', screenshots: [] },
        'themes': { title: 'Themes', screenshots: [] },
        'density': { title: 'Density', screenshots: [] },
        'sections': { title: 'Dashboard Sections', screenshots: [] },
        'panels': { title: 'Live Stream Panel', screenshots: [] },
        'dock-tabs': { title: 'Dock Tabs', screenshots: [] },
        'routing': { title: 'Model Routing', screenshots: [] },
        'modals': { title: 'Modals', screenshots: [] },
        'system': { title: 'System Page', screenshots: [] },
        'progressive': { title: 'Progressive Disclosure', screenshots: [] },
        'responsive': { title: 'Responsive Layouts', screenshots: [] },
        'components': { title: 'UI Components (Focused)', screenshots: [] },
    };

    // Group screenshots by category
    for (const [source, info] of Object.entries(SCREENSHOT_MAPPING)) {
        categories[info.category].screenshots.push(info.target);
    }

    let markdown = '# Dashboard Screenshots\n\n';
    markdown += 'This directory contains screenshots generated from E2E tests for documentation purposes.\n\n';
    markdown += '## Usage\n\n';
    markdown += 'Include screenshots in markdown using:\n\n';
    markdown += '```markdown\n';
    markdown += '![Description](./screenshots/category/filename.png)\n';
    markdown += '```\n\n';
    markdown += '## Regenerate Screenshots\n\n';
    markdown += '```bash\n';
    markdown += 'npm run screenshots:generate\n';
    markdown += 'npm run screenshots:extract\n';
    markdown += '```\n\n';
    markdown += '## Categories\n\n';

    for (const [category, info] of Object.entries(categories)) {
        const categoryPath = category ? `${category}/` : '';
        markdown += `### ${info.title}\n\n`;
        for (const screenshot of info.screenshots) {
            markdown += `- [${screenshot}](./${categoryPath}${screenshot}.png)\n`;
        }
        markdown += '\n';
    }

    return markdown;
}

function main() {
    console.log('ğŸ–¼ï¸  Extracting documentation screenshots...\n');

    // Check if source directory exists
    if (!fs.existsSync(SOURCE_DIR)) {
        console.error(`âŒ Source directory not found: ${SOURCE_DIR}`);
        console.log('   Run screenshots first with:');
        console.log('   npm run screenshots:generate');
        process.exit(1);
    }

    // Create target directory
    ensureDir(TARGET_DIR);

    let copiedCount = 0;
    let missingCount = 0;

    // Copy screenshots
    for (const [source, info] of Object.entries(SCREENSHOT_MAPPING)) {
        const categoryDir = info.category ? path.join(TARGET_DIR, info.category) : TARGET_DIR;
        ensureDir(categoryDir);

        // Try different platform variants
        const platforms = ['chromium-win32', 'chromium-linux', 'chromium-darwin', 'win32', 'linux', 'darwin'];
        let found = false;

        for (const platform of platforms) {
            const sourceFile = path.join(SOURCE_DIR, `${source}-${platform}.png`);
            if (fs.existsSync(sourceFile)) {
                const targetFile = path.join(categoryDir, `${info.target}.png`);
                fs.copyFileSync(sourceFile, targetFile);
                console.log(`âœ… ${info.category ? info.category + '/' : ''}${info.target}.png`);
                copiedCount++;
                found = true;
                break;
            }
        }

        if (!found) {
            console.log(`âš ï¸  ${source} (not found)`);
            missingCount++;
        }
    }

    // Generate README
    const readmePath = path.join(TARGET_DIR, 'README.md');
    fs.writeFileSync(readmePath, generateMarkdownIndex());

    console.log('\n' + '='.repeat(50));
    console.log(`âœ… Copied ${copiedCount} screenshots to ${TARGET_DIR}`);
    if (missingCount > 0) {
        console.log(`âš ï¸  ${missingCount} screenshots not found`);
    }
    console.log(`ğŸ“„ Generated ${readmePath}`);
    console.log('\nScreenshots ready for documentation! ğŸ‰');
}

main();
